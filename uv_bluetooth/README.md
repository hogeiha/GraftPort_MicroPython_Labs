# 紫外线指数检测与显示系统

## 目录
- [简介（Description）](#简介description)
- [主要功能（Features）](#主要功能features)
- [硬件要求（Hardware Requirements）](#硬件要求hardware-requirements)
- [软件环境（Software Environment）](#软件环境software-environment)
- [文件结构（File Structure）](#文件结构file-structure)
- [关键文件说明（File Description）](#关键文件说明file-description)
- [软件设计核心思想（Design Idea）](#软件设计核心思想design-idea)
- [使用说明（Quick Start）](#使用说明quick-start)
- [示例程序（Example）](#示例程序example)
- [注意事项（Notes）](#注意事项notes)
- [版本记录（Version History）](#版本记录version-history)
- [联系开发者（Contact）](#联系开发者contact)
- [许可协议（License）](#许可协议license)

## 简介（Description）

### 项目背景

传统环境监测设备多为固定显示或单一功能，缺乏实时数据展示和无线传输能力。本项目基于GraftPort-RP2040开发板，结合GUVA-S12SD紫外线传感器、HC08蓝牙模块和SSD1306 OLED显示屏，实现"紫外线指数检测-显示-无线传输"一体化系统，解决传统环境监测设备功能单一的问题，同时融入MicroPython的轻量化任务调度与异常处理机制，保证系统稳定运行。

### 项目主要功能概览

本项目基于MicroPython开发，核心功能是通过GUVA-S12SD紫外线传感器实时检测紫外线强度，转换为紫外线指数（UVI），通过OLED显示屏实时显示，同时通过HC08蓝牙模块无线传输数据；支持板载按键中断切换任务启停，内置自动垃圾回收（GC）避免内存泄漏，异常捕获与限速打印便于问题定位。

### 适用场景或应用领域

- **户外活动**：实时监测紫外线强度，提醒用户做好防晒措施；
- **环境监测**：作为便携式紫外线监测设备，用于气象观测、环境研究；
- **教学演示**：用于MicroPython任务调度、ADC数据采集、UART通信、I2C显示等知识点的实践教学；
- **智能穿戴**：集成到可穿戴设备中，提供紫外线防护提醒功能。

## 主要功能（Features）

- **实时紫外线指数检测**：通过GUVA-S12SD传感器每200ms采集一次紫外线强度，转换为标准紫外线指数（UVI）；
- **OLED实时显示**：通过SSD1306 OLED显示屏实时显示当前紫外线指数，数据变化时立即更新显示；
- **蓝牙无线传输**：通过HC08蓝牙模块将紫外线指数数据无线传输到其他设备；
- **按键中断交互**：板载按键触发下降沿中断，可切换核心任务"运行/暂停"，暂停时停止数据采集和显示更新；
- **自动内存管理**：空闲时检测内存，若低于阈值自动触发GC，防止MicroPython因内存泄漏崩溃；
- **异常容错机制**：任务执行抛异常时，完整打印回溯信息并限速，避免刷屏；
- **板级适配灵活**：基于board.py实现引脚映射解耦，支持后续扩展其他RP2040开发板。

## 硬件要求（Hardware Requirements）

项目基于GraftPort-RP2040开发板作为主控：

![GraftPort-RP2040实物图](./docs/graftport_rp2040_board_front.png)

**其余需要的模块包括：**
![GraftSense传感器模块图](./docs/modules.png)
* GtaftSense-GUVA-S12SD紫外线传感器模块（模拟输出，连接ADC引脚）；
* GtaftSense-HC08蓝牙模块（UART通信，默认波特率9600）；
* GtaftSense-SSD1306 OLED显示屏（I2C通信，地址0x3c或0x3d）；
* GtaftSense-SY7656锂电池充放电模块（连接聚合物锂电池，输出5V电压，带Type-C充电接口）；
* 板载按键：默认使用开发板固定引脚（引脚18，上拉输入），无需额外接线。
* 板载LED：默认使用开发板固定引脚（引脚25），无需额外接线。

**连接方式：**

1. **硬件连线**  
   * **GUVA-S12SD紫外线传感器模块**：通过PH2.0连接线接入ADC0接口；
   * **HC08蓝牙模块**：通过PH2.0连接线接入UART0接口；
   * **SSD1306 OLED显示屏**：通过PH2.0连接线接入I2C0接口；
   * **锂电池充放电模块**：BAT接口连接锂电池，OUT接口通过PH2.0连接线为主控板供电。

2. **装置装配**  
   * 使用M3塑料柱将各模块与主控板固定在外壳底板上；
   * 利用M3塑料柱将外壳四周固定好，并在对应位置拧上M3螺丝完成装配。

3. **注意事项**
   * 在主控板不连接外部看门狗模块时，RUN拨码开关2要导通；
   * 锂电池充放电模块支持电量显示，使用Type-C接口即可充电。

## 软件环境（Software Environment）
- 核心固件：MicroPython v1.23.0（需适配GraftPort-RP2040，支持`machine.Pin/I2C/UART/ADC/Timer`模块）；
- 开发IDE：PyCharm（用于代码编写、上传、调试，支持MicroPython REPL交互）；
- 辅助工具：  
  - Python 3.12+（用于运行本地辅助脚本，可选）；  
  - mpy-cross v1.23.0（用于将.py文件编译为.mpy，减少开发板内存占用，可选）；  
  - mpremote v0.11.0+（替代Thonny上传文件，支持命令行操作，可选）；  
- 依赖模块：无额外第三方库，所有驱动均为自定义实现，随项目文件提供。

## 文件结构（File Structure）

```
uv_bluetooth/
├── .flake8                     # Python代码规范检查配置文件（PEP8标准）
├── LICENSE                     # 许可协议文件（CC BY-NC 4.0）
├── README.md                   # 项目说明文档（本文档）
├── tools/                      # 开发辅助工具脚本
│   ├── dependency_analyzer.py  # 项目依赖分析工具（检查模块间引用关系）
│   ├── mpy_compiler.py         # .py文件批量编译为.mpy工具（减少内存占用）
│   ├── mpy_uploader.py         # 通过mpremote上传.mpy文件至开发板的脚本
│   └── README.md               # 工具使用说明文档
├── firmware/                   # 固件代码目录（需上传至开发板的文件）
│   ├── board.py                # 板级引脚映射文件（定义GraftPort-RP2040的硬件接口）
│   ├── boot.py                 # MicroPython启动脚本（默认空，可自定义初始化逻辑）
│   ├── conf.py                 # 系统配置文件（调试开关、GC阈值等参数）
│   ├── main.py                 # 项目入口文件（硬件初始化、任务创建、调度启动）
│   ├── tasks/                  # 任务逻辑模块
│   │   ├── maintenance.py      # 系统维护任务（自动GC、异常处理回调）
│   │   ├── sensor_task.py      # 核心任务（UV采集、OLED显示、蓝牙传输）
│   │   └── __init__.py         # 包初始化文件
│   ├── libs/                   # 通用工具库
│   │   ├── __init__.py         # 包初始化文件
│   │   └── scheduler/          # 任务调度器
│   │       ├── scheduler.py    # 调度器核心实现（任务添加/暂停/恢复、周期调度）
│   │       └── __init__.py     # 包初始化文件
│   └── drivers/                # 硬件驱动模块（按设备分类）
│       ├── __init__.py         # 包初始化文件
│       ├── ssd1306_driver/     # SSD1306 OLED驱动
│       ├── hc08_driver/        # HC08蓝牙模块驱动
│       └── guva_s12sd_driver/  # GUVA-S12SD UV传感器驱动
├── examples/                   # 示例代码目录（预留扩展）
│   └── README.md               # 示例说明文档
└── docs/                       # 项目文档资料目录
    # 存放硬件接线图、设计说明、模块 datasheet、开发板引脚表等文档
```
## 关键文件说明（File Description）

### `main.py` - 项目入口文件

**核心功能**：负责硬件初始化、任务创建、调度器启动和异常处理。

**主要逻辑流程**：
1. **上电延时**：延时3秒等待硬件稳定
2. **硬件初始化**：
   - 板载LED（用于错误指示）
   - 板载按键（配置下降沿中断，回调函数为`button_handler`）
   - UART0串口（用于HC08蓝牙模块通信）
   - ADC引脚（用于GUVA-S12SD紫外线传感器）
   - I2C0总线（用于SSD1306 OLED显示屏）
3. **I2C设备扫描**：自动检测OLED显示屏地址（0x3c或0x3d）
4. **任务创建**：
   - 创建`uvOledTask`实例，封装为调度器任务（周期200ms）
5. **调度器初始化**：
   - 创建`Scheduler`实例（软定时器，调度周期50ms）
   - 添加空闲回调（自动GC）和错误回调（异常处理）
6. **中断处理**：
   - `button_handler`：按键中断回调，切换任务运行/暂停状态
   - `fatal_hang`：严重错误处理函数，LED闪烁并打印错误信息

**关键配置参数**：
- `I2C0_FREQ = 400_000`：I2C时钟频率
- `OLED_ADDRESS = 0x3d`：OLED默认地址
- `button_pressed`：全局按键状态标志

### `tasks/sensor_task.py` - 核心业务任务

**核心类**：`uvOledTask`

**主要功能**：实现紫外线指数检测、OLED显示更新和蓝牙数据传输的完整业务逻辑。

**关键方法**：

1. **`__init__` 初始化方法**：
   - 接收HC08、GUVA_S12SD、SSD1306_I2C硬件实例
   - 设置调试模式开关
   - 初始化状态变量：
     - `firstset`：首次设置标志
     - `uv_last`：上一次UV值记录（用于判断是否需要更新显示）
     - `uv_level`：当前紫外线指数

2. **`tick` 周期执行方法**（每200ms调用）：
   - **数据采集**：从GUVA-S12SD读取当前紫外线指数
   - **蓝牙传输**：将UV指数数据通过HC08蓝牙模块发送
   - **显示更新**：只有当UV指数发生变化时才更新OLED显示，避免频繁刷新
   - **调试输出**：在调试模式下打印当前UV指数

**数据流控制**：
- 采用"变化检测"机制，只有UV指数实际变化时才更新显示
- 蓝牙数据格式：`[0xA5, uv_level, uv_level, 0x5A]`
- OLED显示内容：`"UV Level: [数值]"`

### `tasks/maintenance.py` - 系统维护模块

**核心功能**：提供系统级的维护和容错机制。

**主要函数**（基于项目架构推断）：

1. **`task_idle_callback` 空闲回调**：
   - 调度器空闲时触发自动垃圾回收
   - 检测内存使用情况，低于阈值时执行`gc.collect()`
   - 防止MicroPython因内存泄漏而崩溃

2. **`task_err_callback` 错误回调**：
   - 任务执行抛出异常时触发
   - 打印完整异常回溯信息
   - 限速输出，避免串口刷屏

**配置参数**：
- `GC_THRESHOLD_BYTES`：自动GC触发阈值
- `ERROR_REPEAT_DELAY_S`：错误信息重复输出间隔

### 硬件驱动模块

#### `drivers/hc08_driver.py` - HC08蓝牙模块驱动
- **核心类**：`HC08`
- **主要方法**：`send_data(data)` - 通过UART发送数据
- **通信协议**：UART串口，波特率9600

#### `drivers/ssd1306_driver.py` - SSD1306 OLED显示屏驱动
- **核心类**：`SSD1306_I2C`
- **主要方法**：
  - `fill(color)` - 清屏
  - `text(string, x, y)` - 显示文本
  - `show()` - 更新显示
- **通信协议**：I2C，地址0x3c或0x3d

#### `drivers/guva_s12sd_driver.py` - GUVA-S12SD紫外线传感器驱动
- **核心类**：`GUVA_S12SD`
- **主要属性**：`uvi` - 紫外线指数（只读）
- **工作原理**：通过ADC读取模拟电压值，转换为标准紫外线指数

### `board.py` - 板级支持文件

**核心功能**：实现硬件抽象层，隔离板级差异。

**主要接口**：
- `get_fixed_pin(pin_name)` - 获取固定功能引脚（LED、BUTTON等）
- `get_uart_pins(uart_id)` - 获取UART引脚配置
- `get_adc_pins(adc_id)` - 获取ADC引脚配置
- `get_i2c_pins(i2c_id)` - 获取I2C引脚配置

**设计优势**：
- 板级配置与业务逻辑解耦
- 支持多开发板适配
- 引脚映射集中管理

### `conf.py` - 用户配置文件

**可配置参数**：
```python
ENABLE_DEBUG = True      # 调试信息输出开关
AUTO_START = True        # 系统启动时自动运行任务
```

**容错机制**：
- 所有配置参数都有默认值
- 配置文件缺失不影响核心功能运行
- 支持运行时动态配置

### 设计特点总结

1. **模块化设计**：各功能模块职责清晰，便于维护和测试
2. **错误容错**：关键操作均有异常捕获，系统稳定性高
3. **资源优化**：显示更新采用变化检测，避免不必要的刷新
4. **扩展性强**：新增传感器只需添加对应驱动和任务逻辑
5. **用户体验**：实时数据显示，操作响应及时
## 软件设计核心思想（Design Idea）

### 1. 系统分层思路：采用"四层架构"，实现解耦与复用
- 硬件驱动层（drivers/）：负责硬件的底层控制；
- 任务逻辑层（tasks/）：基于驱动层接口实现业务逻辑；
- 调度控制层（libs/scheduler.py）：提供通用的任务管理能力；
- 入口层（main.py）：负责组装各层，初始化系统。

### 2. 模块划分原则：高内聚、低耦合
- 每个模块只负责单一职责；
- 模块间通过接口交互，不直接操作内部变量；
- 扩展性强，新增硬件只需添加对应驱动和任务。

### 3. 核心机制：保障系统稳定与用户体验
- 任务调度机制：基于软定时器实现，调度周期50ms，核心任务周期200ms；
- 数据更新机制：只有当紫外线指数发生变化时才更新OLED显示，减少不必要的刷新；
- 交互反馈机制：按键中断回调即时生效；
- 容错机制：所有关键操作均用try-except包裹。

## 使用说明（Quick Start）

### 1. 硬件连接
按"硬件要求"中的连接方式，连接主控板、各个传感器模块和电池。

### 2. 运行项目（使用 PyCharm + MicroPython 插件）

1. 打开 PyCharm 并安装对应的 MicroPython 插件。  
![运行步骤1](./docs/dl_step1.png)
2. 在插件中选择 **运行设备（Target Device）** 为 `RP2040`，并启用 **自动检测设备路径（Auto-detect device path）**。  
![运行步骤2](./docs/dl_step2.png)
3. 将 **Project/firmware** 设置为项目根目录。  
![运行步骤3](./docs/dl_step3.png)
4. 修改运行配置：
![运行步骤4](./docs/dl_step4.png)
   - 勾选 **允许多个实例（Allow multiple instances）**  
   - 选择 **存储为项目文件（Store as project file）**  
   - 点击 **确定** 保存配置。
5. 点击 IDE 右上角的绿色三角按钮运行，即可开始上传固件并执行项目。
![运行步骤5](./docs/dl_step5.png)
![运行步骤6](./docs/dl_step6.png)

### 3. 运行配置的修改
修改`conf.py`文件，根据需求配置参数：
```python
# conf.py 示例配置
ENABLE_DEBUG = True            # 是否开启调试打印
AUTO_START = True              # 是否在启动时自动运行任务
```

### 3. 运行项目
1. 打开PyCharm并安装MicroPython插件；
2. 在插件中选择运行设备为`RP2040`，启用自动检测设备路径；
3. 将项目根目录设置为工作目录；
4. 点击运行按钮，开始上传固件并执行项目。

### 4. 功能测试
* **紫外线检测**：将紫外线传感器暴露在不同强度的紫外线下，观察OLED显示是否相应变化；
* **蓝牙传输**：使用蓝牙接收设备验证数据是否正确传输；
* **按键切换**：按下板载按键，任务暂停（停止数据采集和显示更新），再次按下恢复。

## 示例程序（Example）

本项目没有其余参考示例代码，直接在项目文件夹中进行修改即可。

## 注意事项（Notes）

* **传感器相关：**
  * GUVA-S12SD紫外线传感器需要适当的光照条件，避免在完全黑暗环境下使用；
  * 传感器应避免长时间暴露在极强紫外线下，以免损坏。
* **硬件连接相关：**
  * HC08蓝牙模块的UART通信波特率必须设置为9600；
  * SSD1306 OLED显示屏的I2C地址可能为0x3c或0x3d，系统会自动检测。
* **软件版本相关：**
  * 必须使用MicroPython v1.23.0及以上版本；
  * 调试打印会占用一定内存，正式使用时建议关闭。
* **功能使用相关：**
  * 任务周期（200ms）不建议修改过小，否则可能增加系统负载；
  * 自动GC阈值建议根据实际内存使用情况调整。

## 版本记录（Version History）

* **v1.0.0 (2025-10-10)**：侯钧瀚完成初始版本：
  * 支持GUVA-S12SD实时紫外线指数检测；
  * 实现SSD1306 OLED实时显示；
  * 支持HC08蓝牙数据无线传输；
  * 支持按键中断切换任务启停；
  * 适配GraftPort-RP2040开发板。

## 联系开发者（Contact）

如有任何问题或需要帮助，请通过以下方式联系开发者：  
📧 **邮箱**：10696531183@qq.com
💻 **GitHub**：https://github.com/FreakStudioCN
## 许可协议（License）

本项目中，除`machine`等MicroPython官方模块（MIT许可证）外，所有由作者编写的驱动与扩展代码均采用**知识共享署名-非商业性使用 4.0 国际版 (CC BY-NC 4.0)**许可协议发布。

您可以自由地：
- **共享** — 在任何媒介以任何形式复制、发行本作品
- **演绎** — 修改、转换或以本作品为基础进行创作

惟须遵守下列条件：
- **署名** — 您必须给出适当的署名，提供指向本许可协议的链接，同时标明是否作了修改。
- **非商业性使用** — 您不得将本作品用于商业目的。
- **合理引用方式** — 可在代码注释、文档、演示视频或项目说明中明确来源。

**版权归 FreakStudio 所有。**